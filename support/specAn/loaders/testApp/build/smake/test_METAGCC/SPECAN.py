load_info = {
    "path" :
        "./",
    "elfs" : 
    [
        "SPECAN_t0.elf",
        0,
        0,
        0
    ],
    "image" : 
    [
        
    ],
    "overlays" : 
    [
        
    ],
    "pre_load_config" : 
    [
        [0, "WriteLong", "0x02015908", "0x00000000"],
        [0, "Sleep", "4"],
        [0, "WriteLong", "0x02015954", "0x1600000F"],
        [0, "WriteLong", "0x020159AC", "0x00000000"],
        [0, "WriteLong", "0x02015918", "0x00000001"],
        [0, "WriteLong", "0x02015950", "0x12A02560"],
        [0, "Sleep", "4"],
        [0, "WriteLong", "0x02015954", "0x0600000F"],
        [0, "WriteLong", "0x02015954", "0x0400000F"],
        [0, "Sleep", "8"],
        [0, "WriteLong", "0x02015908", "0x00000002"],
        [0, "WriteLong", "0x02018E7C", "0x00000000"],
        [0, "WriteLong", "0x02018D08", "0x00000000"],
        [0, "WriteLong", "0x02018E44", "0x00000002"],
        [0, "WriteLong", "0x02018D10", "0x00000004"],
        [0, "WriteLong", "0x02018D54", "0x0000001F"],
        [0, "WriteLong", "0x02018D98", "0x00000001"],
        [0, "WriteLong", "0x02018DA0", "0x00000000"],
        [0, "WriteLong", "0x02018DA8", "0x00000003"],
        [0, "WriteLong", "0x02018E3C", "0x00000002"],
        [0, "WriteLong", "0x02018E40", "0x00000002"],
        [0, "WriteLong", "0x02018E84", "0x00000097"],
        [0, "WriteLong", "0x02018F6C", "0x00000002"],
        [0, "WriteLong", "0x02018D3C", "0x00000001"],
        [0, "WriteLong", "0x02018DE0", "0x00000008"],
        [0, "WriteLong", "0x02018DE4", "0x00000008"],
        [0, "WriteLong", "0x02018DE8", "0x0000000F"],
        [0, "WriteLong", "0x02018DEC", "0x00000000"],
        [0, "WriteLong", "0x02018DF0", "0x00000000"],
        [0, "WriteLong", "0x02018DF4", "0x00000000"],
        [0, "WriteLong", "0x02018DF8", "0x00000000"],
        [0, "WriteLong", "0x02018DFC", "0x00000000"],
        [0, "WriteLong", "0x02018E00", "0x00000000"],
        [0, "WriteLong", "0x02018E04", "0x0000000F"],
        [0, "WriteLong", "0x02018E08", "0x0000000F"],
        [0, "WriteLong", "0x02018E0C", "0x00000003"],
        [0, "WriteLong", "0x02018E10", "0x00000003"],
        [0, "WriteLong", "0x02018E14", "0x00000003"],
        [0, "WriteLong", "0x02018E18", "0x00000003"],
        [0, "WriteLong", "0x02018E1C", "0x0000000F"],
        [0, "WriteLong", "0x02018E20", "0x0000000F"],
        [0, "WriteLong", "0x02018E24", "0x0000000F"],
        [0, "WriteLong", "0x02018EAC", "0x00000010"],
        [0, "WriteLong", "0x02018E34", "0x00000005"],
        [0, "WriteLong", "0x02018E38", "0x00000005"],
        [0, "WriteLong", "0x02018E94", "0x00000000"],
        [0, "WriteLong", "0x02018E28", "0x00000001"],
        [0, "WriteLong", "0x02018E2C", "0x00000004"],
        [0, "WriteLong", "0x02018E30", "0x00000003"],
        [0, "WriteLong", "0x02018F7C", "0x00000002"],
        [0, "WriteLong", "0x02018F80", "0x00000000"],
        [0, "WriteLong", "0x02018F84", "0x00000000"],
        [0, "WriteLong", "0x02018DB0", "0x0000005A"],
        [0, "WriteLong", "0x02018D4C", "0x00000070"],
        [0, "WriteLong", "0x02018D84", "0x00000003"],
        [0, "WriteLong", "0x02018D40", "0x0000001A"],
        [0, "WriteLong", "0x02018D68", "0x00000003"],
        [0, "WriteLong", "0x02018D58", "0x00000001"],
        [0, "WriteLong", "0x02018D5C", "0x0000001F"],
        [0, "WriteLong", "0x02018D48", "0x00000007"],
        [0, "WriteLong", "0x02018D7C", "0x00000004"],
        [0, "WriteLong", "0x02018E88", "0x00000002"],
        [0, "WriteLong", "0x02018D60", "0x00000013"],
        [0, "WriteLong", "0x02018D94", "0x00000007"],
        [0, "WriteLong", "0x02018D88", "0x00000001"],
        [0, "WriteLong", "0x02018F60", "0x00000004"],
        [0, "WriteLong", "0x02018D50", "0x0000000D"],
        [0, "WriteLong", "0x02018DB4", "0x00000001"],
        [0, "WriteLong", "0x02018D70", "0x0000000A"],
        [0, "WriteLong", "0x02018D64", "0x00000005"],
        [0, "WriteLong", "0x02018F64", "0x00000005"],
        [0, "WriteLong", "0x02018D44", "0x00000031"],
        [0, "WriteLong", "0x02018D8C", "0x00000005"],
        [0, "WriteLong", "0x02018D6C", "0x00000005"],
        [0, "WriteLong", "0x02018D74", "0x00000002"],
        [0, "WriteLong", "0x02018D80", "0x00000006"],
        [0, "WriteLong", "0x02018DB8", "0x00000D52"],
        [0, "WriteLong", "0x02018DBC", "0x00002042"],
        [0, "WriteLong", "0x02018E8C", "0x00004000"],
        [0, "WriteLong", "0x02018E90", "0x00006000"],
        [0, "WriteLong", "0x02018F94", "0x00000044"],
        [0, "WriteLong", "0x02018F98", "0x00000038"],
        [0, "WriteLong", "0x02018F9C", "0x0000003A"],
        [0, "WriteLong", "0x02018FA0", "0x00000044"],
        [0, "WriteLong", "0x02018E7C", "0x00000001"],
        [0, "WriteLong", "0x02018C10", "0x2C000000"],
        [0, "WriteLong", "0x02018C14", "0x2D000000"],
        [0, "WriteLong", "0x02018C18", "0x00000000"],
        [0, "WriteLong", "0x02018C1C", "0x00000000"],
        [0, "Sleep", "28"],
        [0, "WriteLong", "0x04830140", "0x000001CB"],
        [0, "WriteLong", "0x04800010", "0x00020000"],
        [0, "WriteLong", "0x04801010", "0x00020000"],
        [0, "WriteLong", "0x04802010", "0x00020000"],
        [0, "WriteLong", "0x04803010", "0x00020000"],
        [0, "WriteLong", "0x04830640", "0x00000003"],
        [0, "WriteLong", "0x0200065C", "0x00000000"],
        [0, "WriteLong", "0x0200066C", "0x00000000"],
        [0, "WriteLong", "0x0200068C", "0x00000000"],
        [0, "WriteLong", "0x0200069C", "0x00000000"],
        [0, "WriteLong", "0x020006AC", "0x00000000"],
        [0, "WriteLong", "0x020006BC", "0x00000000"],
        [0, "WriteLong", "0x020006CC", "0x00000000"],
        [0, "WriteLong", "0x020006DC", "0x00000000"],
        [0, "WriteLong", "0x020006EC", "0x00000000"],
        [0, "WriteLong", "0x04800070", "0x0000F0F0"],
        [0, "WriteLong", "0x04801070", "0x0000F0F0"],
        [0, "WriteLong", "0x04802070", "0x0000F0F0"],
        [0, "WriteLong", "0x04803070", "0x0000F0F0"],
        [0, "WriteLong", "0x04830010", "0x00000000"],
        [0, "WriteLong", "0x04830028", "0x00000006"],
        [0, "WriteLong", "0x04830600", "0x0000C0C0"],
        [0, "WriteLong", "0x04830038", "0x00000001"],
        [0, "WriteLong", "0x04830040", "0x00000001"],
        [0, "WriteLong", "0x04700000", "0x00000000"],
        [0, "WriteLong", "0x03000000", "0x000033FF"],
        [0, "WriteLong", "0x03000008", "0x000033FF"],
        [0, "WriteLong", "0x03000010", "0x000033FF"],
        [0, "WriteLong", "0x03000018", "0x000033FF"],
        [0, "WriteLong", "0x04830200", "0x80000707"],
        [0, "WriteLong", "0x04830208", "0x88080707"],
        [0, "WriteLong", "0x04830210", "0x80000000"],
        [0, "WriteLong", "0x04830218", "0x80000000"],
        [0, "WriteLong", "0x04830018", "0x00000001"],
        [0, "WriteLong", "0x04830220", "0x00000707"],
        [0, "WriteLong", "0x04830228", "0x08080707"],
        [0, "WriteLong", "0x04830230", "0x00000000"],
        [0, "WriteLong", "0x04830238", "0x00000000"],
        [0, "WriteLong", "0x04830020", "0x00000001"],
        [0, "WriteLong", "0x040000C0", "0x00000000"],
        [0, "WriteLong", "0x048000E8", "0x00000080"]
    ],
    "post_load_config" : 
    [
        [0, "InitMemory", "0x380429C0", "0x4", "0x1000", "0x00000000", "0x00000000"],
        [0, "InitMemory", "0x82000000", "0x4", "0x800", "0x00000000", "0x00000000"],
        [0, "InitMemory", "0xB0FF8000", "0x4", "0x1CB8", "0x00000000", "0x00000000"]
    ]
}

from CSUtils import DA
import time, sys, os, re

program_file_load_option = 0 # load binary and symbols
bootimage_load_option = 0
load_setup=0

for opt in sys.argv:
    if opt.lower() == "-load_binary_only":
        program_file_load_option = 1 # load binary
    elif opt.lower() == "-load_source_only":
        program_file_load_option = 2 # load symbols
    elif opt.lower() == "-debug":
        bootimage_load_option = 1
    elif opt.lower() == "-debug-elf":
        bootimage_load_option = 2    
    elif opt.lower() == "-load-setup":
        load_setup=1    

path = load_info['path'].replace('\\', '/')

def main(hardReset = True, loadType = 0, showProgress = True):
    if DA.EnvironmentName == "CODESCAPE":
        DA.EnableTargetUpdates(DA.GetCurrentTarget(), 0)
    if hardReset:
        DA.HardReset()
    if (load_info["image"]):
        LoadBinaryImage(showProgress)
    else:
        if loadType != 2:
            RunScript(load_info["pre_load_config"])
        LoadAllOverlay(showProgress)
        LoadAllProgram(loadType, showProgress)
        if loadType != 2:
            RunScript(load_info["post_load_config"])
    
    if DA.EnvironmentName == "CODESCAPE":
        DA.EnableTargetUpdates(DA.GetCurrentTarget(), 1)


class DnlParseError(Exception):
    def __init__(self, value):
        self.value = value
    def __str__(self):
        return repr(self.value)

def LoadDNLFile(filepath, loadType = 0, showProgress = True):
    dnlfile = open (filepath, "rU")
    if not dnlfile:
        print "Error: Failed to load DNL file: %s" % filepath
        
    newlines=0
    memblock=range(0,255)
    startaddr=0
    count=0
    inputre=re.compile('^((?:0[xX])?[0-9A-Fa-f]+)(?::((?:0[xX])?[0-9A-Fa-f]+))?/((?:0[xX])?[0-9A-Fa-f]+);(.*)')
    commentre=re.compile('(#|--).*')
    for line in dnlfile:
        newlines+=1

        line=re.sub(commentre, '', line, 0)

        line=line.strip()
        if line == '':
            continue

        match=inputre.match(line)
        if not match:
            print "Error: Mal-formed DNL input at line %d\n" % newlines
            raise DnlParseError(newlines)
            return

        start=int(match.group(1),16)
        end=match.group(2)
        value=int(match.group(3),16)
        rest=match.group(4)

        if rest:
            print "Error: Mal-formed comment after valid DNL input at line %d\n" % newlines
            raise DnlParseError(newlines)
            return

        if startaddr == 0:
            startaddr = start

        if not end:
            if (count > 255 or start != startaddr+count):
                DA.WriteMemoryBlock (startaddr*4, count, 4, memblock, 0)
                startaddr=(start)
                count=0

            if start == startaddr+count:
                memblock.insert(count, value)
                count += 1

        else:
            end=int(end,16)
            if count > 0:
                DA.WriteMemoryBlock (startaddr*4, count, 4, memblock, 0)
                
            DA.InitMemory (start*4, 4, end-start+1, value, 0)
            count=0
            startaddr = 0
            
    if count > 0:
        DA.WriteMemoryBlock (startaddr*4, count, 4, memblock, 0)
        count=0
        startaddr=end+1


def LoadBinaryImage(showProgress = True):
    current_thread = 0
    DA.SelectTarget(DA.GetFirstThread())
    [thread,addr,filename,tablesym]=load_info["image"][:4]
    SelectThread(current_thread, thread)
    if addr != 0:
        print "Loading %s at 0x%X" %( filename, addr )
        DA.LoadBinaryFile(filename, addr, showProgress);
    else:
        print "Loading " + filename
        LoadDNLFile (filename)

    RunScript (load_info["image"][4:])

    if bootimage_load_option == 2:
        if load_setup == 1:
            RunScript(load_info["pre_load_config"])
        LoadAllProgram (0, True)
        if load_setup == 1:
            RunScript(load_info["post_load_config"])
    else:
        LoadAllProgram (2, True)
        
    DA.SelectTarget(DA.GetFirstThread())
    SelectThread(current_thread, thread)
    
    try:
        entry_point = DA.EvaluateSymbol("CodeScapeStart")
    except DA.Error:
        print "Warning : Unable to set PC because CodeScapeStart is not a valid symbol"
    else:
        DA.WriteRegister("pc", entry_point)
        print "Thread%d PC = 0x%08x" % (thread, DA.ReadRegister("pc"))

    if not tablesym:
        return

    try:
        tablebase = DA.EvaluateSymbol(tablesym)
    except DA.Error:
        print "Warning : Unable to find load symbol %s" % tablesym
    else:
        [target,load,size] = DA.ReadMemoryBlock(tablebase, 3, 4)
        if bootimage_load_option != 0 and target != 0 and size == 0:
            DA.WriteMemoryBlock (tablebase, 3, 4, [target,target,size])

        if bootimage_load_option == 1:
            LoadBinaryImageTable (tablebase)
            if load_setup == 1:
                RunScript(load_info["pre_load_config"])        

def LoadBinaryImageTable (tablebase):
    entrysize=12
    i = 0
    DA.EnableAllBreakpoints (0)
    while True:
        [target, load, size] = DA.ReadMemoryBlock(tablebase, 3, 4, 0)
        tablebase += entrysize
        if target == 0:
            break
        if size == 0:
            continue        
        if load == 0:
            DA.MemoryFill (target, 4, size, 0, 0)
        else:
            DA.WriteMemoryBlock (target, size, 4, DA.ReadMemoryBlock (load, size, 4))
    
    DA.EnableAllBreakpoints (1)

def LoadAllProgram(loadType, showProgress):
    current_thread = 0
    load_thread = 0
    DA.SelectTarget(DA.GetFirstThread())
    for elf in load_info['elfs']:
        if elf:
            SelectThread(current_thread, load_thread)
            current_thread=load_thread
            
            print "Loading " + elf
            DA.LoadProgramFileEx(os.path.join(path, elf), False, loadType, showProgress)
            if loadType != 2:
                try:
                    entry_point = DA.EvaluateSymbol("CodeScapeStart")
                except DA.Error:
                    print "Warning : Unable to set PC because CodeScapeStart is not a valid symbol"
                else:
                    DA.WriteRegister("pc", entry_point)
                    print "Thread%d PC = 0x%08x" % (load_thread, DA.ReadRegister("pc"))
            
        load_thread += 1

def LoadAllOverlay(showProgress):
    DA.SelectTarget(DA.GetFirstThread())
    for overlay in load_info['overlays']:
        print "Loading overlay " + overlay
        DA.LoadProgramFileEx(os.path.join(path, overlay), False, 4, showProgress)
        
def SelectThread(current_thread, wanted_thread):
    if current_thread != wanted_thread:
        thr = DA.GetCurrentTarget()
        search_looped = False
        while current_thread != wanted_thread:
            thr = DA.GetNextThread(thr)
            current_thread += 1
            if not thr:
                if search_looped:
                    print "ERROR: Thread %d not found" % wanted_thread
                    raise Exception("ERROR: Thread %d not found" % wanted_thread)
                search_looped = True
                thr = DA.GetFirstThread()
                current_thread = 0
        DA.SelectTarget(thr)
    
def RunScript(commands):
    current_thread = 0
    DA.SelectTarget(DA.GetFirstThread())
    for command in commands:
        this_thread = command.pop(0)
        fn          = command.pop(0)
        SelectThread(current_thread, this_thread)
        current_thread = this_thread
        if fn == "Sleep":
            ms = int(command[0], 0)
            time.sleep(float(ms) / 1000)
        elif fn == "ReadModWrite":
            addr = int(command.pop(0), 0)
            base = int(command.pop(0), 0)
            mask = int(command.pop(0), 0)
            DA.WriteLong(addr, (DA.ReadLong(addr) & ~mask) | (base & mask))
        else:
            getattr(DA, fn)(*command)

if __name__ == "__main__":
    main(program_file_load_option != 2, program_file_load_option)

# --- LDLK template ends ---
